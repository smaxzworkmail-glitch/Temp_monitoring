<!DOCTYPE html>
<html lang="uk">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">–ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, sans-serif;
            background: #121212;
            color: #eee;
            margin: 0;
            padding: 15px;
            padding-bottom: 80px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        h1 {
            font-size: 1.2rem;
            color: #00adb5;
            margin: 0;
            flex: 1;
            cursor: pointer;
            text-align: center;
        }

        .card {
            background: #1e1e1e;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .temp-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .temp-item {
            background: #252525;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.1s;
        }

        .temp-item:active {
            transform: scale(0.95);
        }

        .temp-item .color-box {
            display: inline-block;
            width: 24px;
            height: 24px;
            border-radius: 6px;
            margin-bottom: 8px;
            border: 2px solid #333;
        }

        .temp-name {
            display: block;
            font-size: 0.9rem;
            color: #00adb5;
            font-weight: bold;
            margin-bottom: 5px;
            word-break: break-word;
        }

        .temp-val {
            font-size: 1.5rem;
            font-weight: bold;
            display: block;
        }

        .label {
            font-size: 0.8rem;
            color: #888;
            margin-bottom: 5px;
        }

        .chart-container {
            position: relative;
            height: 220px;
            margin-bottom: 10px;
        }

        canvas {
            width: 100% !important;
            height: 100% !important;
        }

        /* Footer */
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #1e1e1e;
            border-top: 1px solid #333;
            padding: 15px;
            text-align: center;
            z-index: 10;
        }

        .time-display {
            font-size: 1.5rem;
            color: #00adb5;
            cursor: pointer;
            font-weight: bold;
        }

        .server-name {
            font-size: 0.75rem;
            color: #666;
            margin-top: 5px;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #1e1e1e;
            border-radius: 12px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            color: #00adb5;
            font-size: 24px;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .form-group input[type="text"] {
            width: 100%;
            padding: 8px;
            background: #252525;
            border: 1px solid #333;
            border-radius: 6px;
            color: #eee;
        }

        .color-picker-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn {
            background: #00adb5;
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-cancel {
            background: #555;
            color: #eee;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: flex-end;
        }

        /* Chart Overlays */
        .crosshair-line {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 1px;
            background: #00adb5;
            opacity: 0.5;
            pointer-events: none;
            display: none;
        }

        .tooltip-hover {
            position: absolute;
            background: #252525;
            border: 1px solid #00adb5;
            padding: 8px;
            border-radius: 6px;
            font-size: 0.85rem;
            pointer-events: none;
            display: none;
            z-index: 100;
        }
    </style>
</head>

<body>
    <div class="header">
        <h1 id="app-title">üå°Ô∏è –°–∏—Å—Ç–µ–º–∞ –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É</h1>
    </div>

    <div id="live-temps" class="temp-grid"></div>

    <div class="card">
        <div class="label">–û—Å—Ç–∞–Ω–Ω—è –≥–æ–¥–∏–Ω–∞ (–æ–Ω–æ–≤–ª–µ–Ω–Ω—è 1 —Ö–≤)</div>
        <div class="chart-container">
            <div class="crosshair-line" id="hourCrosshair"></div>
            <div class="tooltip-hover" id="hourTooltip"></div>
            <canvas id="hourChart"></canvas>
        </div>
    </div>

    <div class="card">
        <div class="label">–î–æ–±–æ–≤–∏–π –≥—Ä–∞—Ñ—ñ–∫ (–æ–Ω–æ–≤–ª–µ–Ω–Ω—è 15 —Ö–≤)</div>
        <div class="chart-container">
            <div class="crosshair-line" id="dayCrosshair"></div>
            <div class="tooltip-hover" id="dayTooltip"></div>
            <canvas id="dayChart"></canvas>
        </div>
    </div>

    <div class="footer">
        <div class="time-display" id="timeDisplay" onclick="openNTPModal()">--:-- --</div>
        <div class="server-name" id="serverName">...</div>
    </div>

    <div id="sensorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–î–∞—Ç—á–∏–∫</h2>
                <button class="modal-close" onclick="closeModal('sensorModal')">‚úï</button>
            </div>
            <div class="form-group">
                <label>–ù–∞–∑–≤–∞</label>
                <input type="text" id="sensorName">
            </div>
            <div class="form-group">
                <label>–ö–æ–ª—ñ—Ä</label>
                <div class="color-picker-group">
                    <input type="color" id="sensorColor">
                </div>
            </div>
            <div class="btn-group">
                <button class="btn" onclick="saveSensorConfig()">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                <button class="btn btn-cancel" onclick="closeModal('sensorModal')">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            </div>
        </div>
    </div>

    <div id="ntpModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–ß–∞—Å</h2>
                <button class="modal-close" onclick="closeModal('ntpModal')">‚úï</button>
            </div>
            <div class="form-group">
                <label>NTP —Å–µ—Ä–≤–µ—Ä</label>
                <input type="text" id="ntpServer">
            </div>
            <div class="btn-group">
                <button class="btn" onclick="saveNTPConfig()">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                <button class="btn btn-cancel" onclick="closeModal('ntpModal')">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            </div>
        </div>
    </div>

    <script>
        const COLORS = ['#ff5722', '#00adb5', '#8bc34a', '#ffeb3b', '#e91e63'];
        let hourChart, dayChart;
        let config = {};
        let editingSensorId = null;

        // --- –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è ---
        async function init() {
            initCharts();

            try {
                // 1. –°–ø–æ—á–∞—Ç–∫—É –∫–æ–Ω—Ñ—ñ–≥ —ñ –∂–∏–≤—ñ –¥–∞–Ω—ñ
                await loadConfig();
                await updateLive();

                // 2. –ù–µ–≤–µ–ª–∏–∫–∞ –ø–∞—É–∑–∞ 500–º—Å, —â–æ–± ESP "–≤—ñ–¥–¥–∏—Ö–∞–ª–∞—Å—è"
                await new Promise(r => setTimeout(r, 500));

                // 3. –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –≥—Ä–∞—Ñ—ñ–∫–∏ –ø–æ —á–µ—Ä–∑—ñ
                await updateHourChart();
                await new Promise(r => setTimeout(r, 500));
                await updateDayChart();

            } catch (e) { console.error("–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó", e); }

            // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —ñ–Ω—Ç–µ—Ä–≤–∞–ª—ñ–≤
            setInterval(updateLive, 10000);
            setInterval(updateHourChart, 60000);
            setInterval(updateDayChart, 900000);
            setInterval(updateTime, 1000);
        }

        function initCharts() {
            const options = {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        ticks: {
                            color: '#888',
                            maxTicksLimit: 8, // <--- –î–û–î–ê–ù–û: –æ–±–º–µ–∂–µ–Ω–Ω—è –∫—ñ–ª—å–∫–æ—Å—Ç—ñ –º—ñ—Ç–æ–∫
                            maxRotation: 0    // <--- –î–û–î–ê–ù–û: —Ç–µ–∫—Å—Ç –∑–∞–≤–∂–¥–∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ
                        }
                    },
                    y: {
                        grid: { color: '#333' },
                        ticks: { color: '#888' }
                    }
                },
                plugins: {
                    legend: { position: 'bottom', labels: { color: '#ccc', boxWidth: 12 } },
                    tooltip: { enabled: false }
                },
                animation: { duration: 400 },
                interaction: { intersect: false, mode: 'index' }
            };

            // –î–∞–ª—ñ –π–¥–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —Å–∞–º–∏—Ö –≥—Ä–∞—Ñ—ñ–∫—ñ–≤...
            hourChart = new Chart(document.getElementById('hourChart'), { type: 'line', data: { labels: [], datasets: [] }, options });
            dayChart = new Chart(document.getElementById('dayChart'), { type: 'line', data: { labels: [], datasets: [] }, options });

            setupChartInteraction('hourChart', 'hourCrosshair', 'hourTooltip', hourChart);
            setupChartInteraction('dayChart', 'dayCrosshair', 'dayTooltip', dayChart);
        }

        async function loadConfig() {
            try {
                const res = await fetch('/api/config');
                config = await res.json();
                document.getElementById('app-title').textContent = 'üå°Ô∏è ' + (config.title || '–ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥');
                document.getElementById('serverName').textContent = config.ntpServer || 'pool.ntp.org';
            } catch (e) { console.error("Config fail", e); }
        }

        async function updateLive() {
            try {
                const res = await fetch('/api/data');
                const sensors = await res.json();
                window.allSensors = sensors;

                const liveDiv = document.getElementById('live-temps');
                liveDiv.innerHTML = sensors.map((s, i) => {
                    const col = s.color || COLORS[i % COLORS.length];
                    return `
                    <div class="temp-item" onclick="openSensorModal(${i})">
                        <div class="color-box" style="background-color: ${col};"></div>
                        <span class="temp-name">${s.name}</span>
                        <span class="temp-val">${s.current > -50 ? s.current.toFixed(1) : '--'}¬∞C</span>
                    </div>`;
                }).join('');
            } catch (e) { console.error("Live update fail", e); }
        }

        async function updateHourChart() {
            if (window.allSensors) {
                renderChartFromData(hourChart, window.allSensors, 'hour', 'hourTime');
            }
        }

        async function updateDayChart() {
            if (window.allSensors) {
                renderChartFromData(dayChart, window.allSensors, 'day', 'dayTime');
            }
        }

        function renderChartFromData(chart, sensors, dataKey, timeKey) {
            if (!sensors || sensors.length === 0) return;

            // –ë–µ—Ä–µ–º–æ –º—ñ—Ç–∫–∏ —á–∞—Å—É –∑ –ø–µ—Ä—à–æ–≥–æ –¥–∞—Ç—á–∏–∫–∞ (–≤–æ–Ω–∏ –æ–¥–Ω–∞–∫–æ–≤—ñ –¥–ª—è –≤—Å—ñ—Ö)
            chart.data.labels = sensors[0][timeKey].map(t => {
                let d = new Date(t * 1000); // Unix TS –≤ –º—ñ–ª—ñ—Å–µ–∫—É–Ω–¥–∏
                return d.getHours().toString().padStart(2, '0') + ':' +
                    d.getMinutes().toString().padStart(2, '0');
            });

            chart.data.datasets = sensors.map((s, i) => ({
                label: s.name,
                data: s[dataKey],
                borderColor: s.color || COLORS[i % COLORS.length],
                tension: 0.3,
                pointRadius: 0
            }));
            chart.update('none');
        }

        function renderChart(chart, logs, sensors, labelStep) {
            // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞: —è–∫—â–æ –Ω–µ–º–∞—î –ª–æ–≥—ñ–≤ –∞–±–æ –æ–ø–∏—Å—É –¥–∞—Ç—á–∏–∫—ñ–≤ - –Ω—ñ—á–æ–≥–æ –Ω–µ —Ä–æ–±–∏–º–æ
            if (!logs || !Array.isArray(logs) || logs.length === 0 || !sensors || sensors.length === 0) {
                console.warn("–î–∞–Ω—ñ –¥–ª—è –≥—Ä–∞—Ñ—ñ–∫–∞ –≤—ñ–¥—Å—É—Ç–Ω—ñ –∞–±–æ –ø–æ—à–∫–æ–¥–∂–µ–Ω—ñ");
                return;
            }

            try {
                chart.data.labels = logs.map((line, idx) => {
                    const p = line.split(',');
                    return (p[0] && idx % labelStep === 0) ? p[0].trim() : '';
                });

                chart.data.datasets = sensors.map((s, i) => {
                    if (!s) return { label: '?', data: [] }; // –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ undefined
                    const color = s.color || COLORS[i % COLORS.length];
                    return {
                        label: s.name || `–î–∞—Ç—á–∏–∫ ${i + 1}`,
                        data: logs.map(line => {
                            const p = line.split(',');
                            const val = parseFloat(p[i + 1]);
                            return (isNaN(val) || val <= -50) ? null : val;
                        }),
                        borderColor: color,
                        backgroundColor: color,
                        tension: 0.3,
                        pointRadius: 0,
                        borderWidth: 2
                    };
                });

                chart.update('none');
            } catch (err) {
                console.error("–ü–æ–º–∏–ª–∫–∞ –≤—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—ó –≥—Ä–∞—Ñ—ñ–∫–∞:", err);
            }
        }

        function updateTime() {
            const now = new Date();
            const fmt = (n) => String(n).padStart(2, '0');
            document.getElementById('timeDisplay').textContent =
                `${fmt(now.getDate())}.${fmt(now.getMonth() + 1)} ${fmt(now.getHours())}:${fmt(now.getMinutes())}`;
        }

        function setupChartInteraction(canvasId, crossId, toolId, chart) {
            const canvas = document.getElementById(canvasId);
            const cross = document.getElementById(crossId);
            const tool = document.getElementById(toolId);

            const handleMove = (e) => {
                // –Ø–∫—â–æ —Ü–µ –¥–æ—Ç–∏–∫, –≤—ñ–¥–º—ñ–Ω—è—î–º–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É –ø—Ä–æ–∫—Ä—É—Ç–∫—É —Å—Ç–æ—Ä—ñ–Ω–∫–∏
                if (e.type === 'touchmove' || e.type === 'touchstart') {
                    if (e.cancelable) e.preventDefault();
                }

                const rect = canvas.getBoundingClientRect();
                // –û—Ç—Ä–∏–º—É—î–º–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—É X (–∞–±–æ –≤—ñ–¥ –º–∏—à–∫–∏, –∞–±–æ –≤—ñ–¥ –ø–µ—Ä—à–æ–≥–æ –ø–∞–ª—å—Ü—è)
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const x = clientX - rect.left;

                // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –Ω–∞–π–±–ª–∏–∂—á—É —Ç–æ—á–∫—É –Ω–∞ –≥—Ä–∞—Ñ—ñ–∫—É
                const points = chart.getElementsAtEventForMode(e, 'index', { intersect: false }, true);

                if (points.length > 0) {
                    const idx = points[0].index;
                    cross.style.display = 'block';
                    cross.style.left = chart.scales.x.getPixelForValue(idx) + 'px';

                    let html = `<strong>${chart.data.labels[idx] || '–ó–∞–ø–∏—Å'}</strong><br>`;
                    chart.data.datasets.forEach(ds => {
                        const v = ds.data[idx];
                        if (v !== null && v !== undefined) {
                            html += `<span style="color:${ds.borderColor}">‚óè</span> ${ds.label}: ${v.toFixed(1)}¬∞C<br>`;
                        }
                    });

                    tool.innerHTML = html;
                    tool.style.display = 'block';

                    // –†–æ–∑—É–º–Ω–µ –ø–æ–∑–∏—Ü—ñ–æ–Ω—É–≤–∞–Ω–Ω—è —Ç—É–ª—Ç—ñ–ø–∞, —â–æ–± –≤—ñ–Ω –Ω–µ –≤–∏–ª–∞–∑–∏–≤ –∑–∞ –∫—Ä–∞–π –µ–∫—Ä–∞–Ω–∞
                    const toolWidth = 120;
                    let posX = x + 15;
                    if (posX + toolWidth > rect.width) {
                        posX = x - toolWidth - 15;
                    }
                    tool.style.left = posX + 'px';
                }
            };

            // –°–ª—É—Ö–∞—á—ñ –¥–ª—è –º–∏—à–∫–∏
            canvas.addEventListener('mousemove', handleMove);
            canvas.addEventListener('mouseleave', () => {
                cross.style.display = 'none';
                tool.style.display = 'none';
            });

            // –°–ª—É—Ö–∞—á—ñ –¥–ª—è —Å–µ–Ω—Å–æ—Ä–Ω–æ–≥–æ –µ–∫—Ä–∞–Ω–∞ (–ø–∞—Å–∏–≤–Ω–∏–π —Ä–µ–∂–∏–º false –¥–æ–∑–≤–æ–ª—è—î preventDefault)
            canvas.addEventListener('touchstart', handleMove, { passive: false });
            canvas.addEventListener('touchmove', handleMove, { passive: false });
            canvas.addEventListener('touchend', () => {
                cross.style.display = 'none';
                tool.style.display = 'none';
            });
        }

        function openSensorModal(id) {
            editingSensorId = id;
            const s = window.allSensors[id];
            document.getElementById('sensorName').value = s.name;
            document.getElementById('sensorColor').value = s.color || COLORS[id % COLORS.length];
            document.getElementById('sensorModal').classList.add('active');
        }

        function openNTPModal() {
            document.getElementById('ntpServer').value = config.ntpServer || 'pool.ntp.org';
            document.getElementById('ntpModal').classList.add('active');
        }

        function closeModal(mId) { document.getElementById(mId).classList.remove('active'); }

        async function saveSensorConfig() {
            if (!config.sensors) config.sensors = [];
            config.sensors[editingSensorId] = {
                id: editingSensorId,
                name: document.getElementById('sensorName').value,
                color: document.getElementById('sensorColor').value
            };
            await sendConfig();
            closeModal('sensorModal');
            updateLive();
        }

        async function saveNTPConfig() {
            config.ntpServer = document.getElementById('ntpServer').value;
            await sendConfig();
            document.getElementById('serverName').textContent = config.ntpServer;
            closeModal('ntpModal');
        }

        async function sendConfig() {
            await fetch('/api/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            });
        }

        init();
    </script>
</body>

</html>