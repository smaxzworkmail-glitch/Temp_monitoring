<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">–ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { font-family: -apple-system, sans-serif; background: #121212; color: #eee; margin: 0; padding: 15px; padding-bottom: 80px; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        h1 { font-size: 1.2rem; color: #00adb5; margin: 0; flex: 1; cursor: pointer; text-align: center; }
        h1:active { opacity: 0.7; }
        
        .card { background: #1e1e1e; border-radius: 12px; padding: 15px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .temp-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .temp-item { background: #252525; padding: 10px; border-radius: 8px; text-align: center; cursor: pointer; transition: transform 0.1s; }
        .temp-item:active { transform: scale(0.95); }
        .temp-item .color-box { display: inline-block; width: 24px; height: 24px; border-radius: 6px; margin-bottom: 8px; border: 2px solid #333; }
        .temp-name { display: block; font-size: 0.9rem; color: #00adb5; font-weight: bold; cursor: pointer; margin-bottom: 5px; word-break: break-word; }
        .temp-val { font-size: 1.5rem; font-weight: bold; display: block; }
        .label { font-size: 0.8rem; color: #888; }
        canvas { max-width: 100%; }
        
        /* Footer */
        .footer { position: fixed; bottom: 0; left: 0; right: 0; background: #1e1e1e; border-top: 1px solid #333; padding: 15px; text-align: center; }
        .time-display { font-size: 1.5rem; color: #00adb5; cursor: pointer; font-weight: bold; }
        .time-display:active { opacity: 0.7; }
        .server-name { font-size: 0.75rem; color: #666; margin-top: 5px; }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background: #1e1e1e; border-radius: 12px; padding: 20px; max-width: 90%; width: 400px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { margin: 0; }
        .modal-close { background: none; border: none; color: #00adb5; font-size: 24px; cursor: pointer; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 0.9rem; }
        .form-group input[type="text"] { width: 100%; padding: 8px; background: #252525; border: 1px solid #333; border-radius: 6px; color: #eee; font-family: inherit; }
        .form-group input[type="text"]:focus { outline: none; border-color: #00adb5; }
        .color-picker-group { display: flex; gap: 10px; align-items: center; }
        .color-picker-group input[type="color"] { width: 60px; height: 40px; border: none; border-radius: 6px; cursor: pointer; }
        .color-value { color: #aaa; font-size: 0.9rem; min-width: 70px; }
        .btn { background: #00adb5; color: #000; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn:active { transform: scale(0.95); }
        .btn-cancel { background: #555; color: #eee; }
        .btn-group { display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end; }
        
        .chart-container { position: relative; margin-bottom: 10px; }
        .crosshair-line { position: absolute; top: 0; bottom: 0; width: 1px; background: #00adb5; opacity: 0.5; pointer-events: none; display: none; }
        .tooltip-hover { position: absolute; background: #252525; border: 1px solid #00adb5; padding: 8px; border-radius: 6px; font-size: 0.85rem; pointer-events: none; display: none; z-index: 100; }
    </style>
</head>
<body>
    <div class="header">
        <h1 id="app-title">üå°Ô∏è –°–∏—Å—Ç–µ–º–∞ –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É</h1>
    </div>
    
    <div id="live-temps" class="temp-grid"></div>

    <div class="card">
        <div class="label">–ì–æ–¥–∏–Ω–∞</div>
        <div class="chart-container">
            <div class="crosshair-line" id="hourCrosshair"></div>
            <div class="tooltip-hover" id="hourTooltip"></div>
            <canvas id="hourChart"></canvas>
        </div>
    </div>

    <div class="card">
        <div class="label">–î–æ–±–∞</div>
        <div class="chart-container">
            <div class="crosshair-line" id="dayCrosshair"></div>
            <div class="tooltip-hover" id="dayTooltip"></div>
            <canvas id="dayChart"></canvas>
        </div>
    </div>

    <!-- Footer –∑ —á–∞—Å–æ–º -->
    <div class="footer">
        <div class="time-display" id="timeDisplay" onclick="openNTPModal()">--:-- --</div>
        <div class="server-name" id="serverName">system</div>
    </div>

    <!-- Modal –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –¥–∞—Ç—á–∏–∫–∞ -->
    <div id="sensorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –¥–∞—Ç—á–∏–∫–∞</h2>
                <button class="modal-close" onclick="closeSensorModal()">‚úï</button>
            </div>
            <div class="form-group">
                <label>–ù–∞–∑–≤–∞ –¥–∞—Ç—á–∏–∫–∞</label>
                <input type="text" id="sensorName" placeholder="–ù–∞–∑–≤–∞">
            </div>
            <div class="form-group">
                <label>–ö–æ–ª—ñ—Ä</label>
                <div class="color-picker-group">
                    <input type="color" id="sensorColor">
                    <span class="color-value" id="colorValue"></span>
                </div>
            </div>
            <div class="btn-group">
                <button class="btn" onclick="saveSensorConfig()">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                <button class="btn btn-cancel" onclick="closeSensorModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            </div>
        </div>
    </div>

    <!-- Modal –¥–ª—è NTP -->
    <div id="ntpModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —á–∞—Å—É</h2>
                <button class="modal-close" onclick="closeNTPModal()">‚úï</button>
            </div>
            <div class="form-group">
                <label>NTP —Å–µ—Ä–≤–µ—Ä</label>
                <input type="text" id="ntpServer" placeholder="pool.ntp.org">
            </div>
            <div class="btn-group">
                <button class="btn" onclick="saveNTPConfig()">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                <button class="btn btn-cancel" onclick="closeNTPModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            </div>
        </div>
    </div>

    <script>
        const defaultColors = ['#ff5722', '#00adb5', '#8bc34a', '#ffeb3b', '#e91e63'];
        
        let hourChart, dayChart;
        let config = {};
        let editingSensorId = null;

        function initCharts() {
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: true,
                scales: { 
                    x: { 
                        display: true,
                        ticks: { color: '#888', maxTicksLimit: 6 }
                    }, 
                    y: { 
                        grid: { color: '#333' },
                        ticks: { color: '#888' }
                    } 
                },
                plugins: { 
                    legend: { position: 'bottom', labels: { color: '#ccc' } },
                    tooltip: { enabled: true, mode: 'index', intersect: false }
                },
                animation: false,
                interaction: { intersect: false, mode: 'index' }
            };

            hourChart = new Chart(document.getElementById('hourChart'), { 
                type: 'line', 
                data: { labels: [], datasets: [] }, 
                options: commonOptions 
            });
            
            dayChart = new Chart(document.getElementById('dayChart'), { 
                type: 'line', 
                data: { labels: [], datasets: [] }, 
                options: commonOptions 
            });
        }

        function updateTime() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const mins = String(now.getMinutes()).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();
            
            document.getElementById('timeDisplay').textContent = `${day}.${month}.${year} ${hours}:${mins}`;
        }

        function formatTimeLabel(minutes) {
            const hour = Math.floor(minutes / 60);
            const min = minutes % 60;
            return `${String(hour).padStart(2, '0')}:${String(min).padStart(2, '0')}`;
        }

        async function updateData() {
            try {
                const res = await fetch('/api/data');
                const data = await res.json();
                
                const liveDiv = document.getElementById('live-temps');
                liveDiv.innerHTML = '';
                
                // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∫–æ–Ω—Ñ—ñ“ë—É—Ä–∞—Ü—ñ—é –¥–ª—è –Ω–∞–∑–≤–∏ —Ç–∞ —Å–µ—Ä–≤–µ—Ä—É
                if (!config.title) {
                    const cfgRes = await fetch('/api/config');
                    config = await cfgRes.json();
                    document.getElementById('app-title').textContent = 'üå°Ô∏è ' + config.title;
                    document.getElementById('serverName').textContent = config.ntpServer;
                    document.title = config.title;
                }
                
                data.forEach((sensor, i) => {
                    // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –∫–æ–ª—ñ—Ä –∑ –∫–æ–Ω—Ñ—ñ–≥—É, –∞–±–æ –¥–µ—Ñ–æ–ª—Ç–Ω–∏–π
                    const color = sensor.color || defaultColors[i % defaultColors.length];
                    
                    const tempHtml = `
                        <div class="temp-item" onclick="openSensorModal(${i})">
                            <div class="color-box" style="background-color: ${color};"></div>
                            <span class="temp-name" onclick="event.stopPropagation();">${sensor.name}</span>
                            <span class="temp-val">${sensor.current > -50 ? sensor.current.toFixed(1) : '--'}¬∞C</span>
                        </div>
                    `;
                    liveDiv.innerHTML += tempHtml;
                    
                    // –î–∞–Ω—ñ –¥–ª—è –≥—Ä–∞—Ñ—ñ–∫—ñ–≤ –∑ —á–∞—Å–æ–≤–∏–º–∏ –º—ñ—Ç–∫–∞–º–∏
                    updateDataset(hourChart, i, sensor.name, sensor.hour, sensor.hourTime, color, false);
                    updateDataset(dayChart, i, sensor.name, sensor.day, sensor.dayTime, color, true);
                });
                // –î–æ–¥–∞–π —Ü–µ —Ç–∞–º, –¥–µ —Ç–∏ –æ—Ç—Ä–∏–º—É—î—à –¥–∞–Ω—ñ –∑ /logs
                const logsRes = await fetch('/logs');
                const logsData = await logsRes.json(); // –û—Ç—Ä–∏–º—É—î–º–æ ["17:34 | 30.0 | 25.7", ...]

                // –û—á–∏—â–∞—î–º–æ –≥—Ä–∞—Ñ—ñ–∫ –ø–µ—Ä–µ–¥ –∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è–º
                hourChart.data.labels = [];
                hourChart.data.datasets[0].data = [];
                hourChart.data.datasets[1].data = [];

                logsData.forEach(line => {
                    const p = line.split('|').map(s => s.trim());
                    if (p.length >= 3) {
                        hourChart.data.labels.push(p[0]); // –ß–∞—Å
                        hourChart.data.datasets[0].data.push(parseFloat(p[1])); // –¢–µ–º–ø 1
                        hourChart.data.datasets[1].data.push(parseFloat(p[2])); // –¢–µ–º–ø 2
                    }
                });
                hourChart.update();
                dayChart.update();
                setupChartInteraction();
            } catch (e) { console.error("Data error", e); }
        }

        function updateDataset(chart, index, name, points, times, color, isDayChart) {
            if (!chart.data.datasets[index]) {
                chart.data.datasets[index] = { 
                    label: name, 
                    data: [], 
                    borderColor: color, 
                    backgroundColor: color + '20',
                    tension: 0.3, 
                    pointRadius: 0,
                    borderWidth: 2
                };
            } else {
                chart.data.datasets[index].label = name;
                chart.data.datasets[index].borderColor = color;
                chart.data.datasets[index].backgroundColor = color + '20';
            }
            chart.data.datasets[index].data = points;
            
            // –ì–µ–Ω–µ—Ä—É—î–º–æ —á–∞—Å–æ–≤—ñ –º—ñ—Ç–∫–∏
            if (times && times.length > 0) {
                chart.data.labels = times.map((t, i) => {
                    if (isDayChart) {
                        // –î–ª—è –¥–æ–±–æ–≤–æ–≥–æ –≥—Ä–∞—Ñ—ñ–∫–∞ –ø–æ–∫–∞–∑—É—î–º–æ —á–∞—Å –∫–æ–∂–Ω—ñ 12 —Ç–æ—á–æ–∫ (3 –≥–æ–¥–∏–Ω–∏)
                        return i % 12 === 0 ? formatTimeLabel(t) : '';
                    } else {
                        // –î–ª—è –≥–æ–¥–∏–Ω–Ω–æ–≥–æ –≥—Ä–∞—Ñ—ñ–∫–∞ –ø–æ–∫–∞–∑—É—î–º–æ —á–∞—Å –∫–æ–∂–Ω—ñ 10 —Ç–æ—á–æ–∫
                        return i % 10 === 0 ? formatTimeLabel(t) : '';
                    }
                });
            }
        }

        function setupChartInteraction() {
            setupChartCrosshair('hourChart', 'hourCrosshair', 'hourTooltip', hourChart);
            setupChartCrosshair('dayChart', 'dayCrosshair', 'dayTooltip', dayChart);
        }

        function setupChartCrosshair(canvasId, crosshairId, tooltipId, chart) {
            const canvas = document.getElementById(canvasId);
            const crosshair = document.getElementById(crosshairId);
            const tooltip = document.getElementById(tooltipId);
            
            canvas.addEventListener('mousemove', (e) => showChartCrosshair(e, canvas, crosshair, tooltip, chart));
            canvas.addEventListener('mouseleave', () => {
                crosshair.style.display = 'none';
                tooltip.style.display = 'none';
            });
            
            canvas.addEventListener('touchmove', (e) => showChartCrosshair(e, canvas, crosshair, tooltip, chart));
            canvas.addEventListener('touchend', () => {
                crosshair.style.display = 'none';
                tooltip.style.display = 'none';
            });
        }

        function showChartCrosshair(e, canvas, crosshair, tooltip, chart) {
            const rect = canvas.getBoundingClientRect();
            const x = e.touches ? e.touches[0].clientX - rect.left : e.offsetX;
            
            const canvasWidth = canvas.width;
            const dataLength = chart.data.datasets[0]?.data.length || 1;
            const dataIndex = Math.round((x / canvasWidth) * dataLength);
            
            // –ü–æ–∫–∞–∑—É—î–º–æ –ª—ñ–Ω—ñ—é
            crosshair.style.display = 'block';
            crosshair.style.left = x + 'px';
            
            // –ü–æ–∫–∞–∑—É—î–º–æ –¥–∞–Ω—ñ
            if (dataIndex >= 0 && dataIndex < dataLength) {
                const now = new Date();
                const currentDate = new Date(now.getTime() - (dataLength - dataIndex) * 60000); // –ü—Ä–∏–±–ª—ñ–∂–Ω–∞ –¥–∞—Ç–∞
                const day = String(currentDate.getDate()).padStart(2, '0');
                const month = String(currentDate.getMonth() + 1).padStart(2, '0');
                const hours = String(currentDate.getHours()).padStart(2, '0');
                const mins = String(currentDate.getMinutes()).padStart(2, '0');
                
                let tooltipText = `<strong>${day}.${month} ${hours}:${mins}</strong><br>`;
                let hasData = false;
                
                chart.data.datasets.forEach(dataset => {
                    const val = dataset.data[dataIndex];
                    if (val !== undefined && val > -50) {
                        tooltipText += `${dataset.label}: ${val.toFixed(1)}¬∞C<br>`;
                        hasData = true;
                    }
                });
                
                if (hasData) {
                    tooltip.innerHTML = tooltipText;
                    tooltip.style.display = 'block';
                    tooltip.style.left = Math.min(x + 10, canvasWidth - 150) + 'px';
                    tooltip.style.top = '10px';
                }
            }
        }

        // –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –¥–∞—Ç—á–∏–∫–∞
        function openSensorModal(sensorId) {
            editingSensorId = sensorId;
            const sensor = config.sensors[sensorId];
            const colorInput = document.getElementById('sensorColor');
            const colorValue = document.getElementById('colorValue');
            
            document.getElementById('sensorName').value = sensor.name;
            const sensorColor = sensor.color || defaultColors[sensorId % defaultColors.length];
            colorInput.value = sensorColor;
            colorValue.textContent = sensorColor;
            
            colorInput.addEventListener('change', () => {
                colorValue.textContent = colorInput.value;
            });
            
            document.getElementById('sensorModal').classList.add('active');
        }

        function closeSensorModal() {
            document.getElementById('sensorModal').classList.remove('active');
            editingSensorId = null;
        }

        function saveSensorConfig() {
            if (editingSensorId === null) return;
            
            const updatedConfig = {
                title: config.title,
                ntpServer: config.ntpServer,
                updateInterval: config.updateInterval,
                sensors: config.sensors.map((s, i) => ({
                    id: i,
                    name: i === editingSensorId ? document.getElementById('sensorName').value : s.name,
                    color: i === editingSensorId ? document.getElementById('sensorColor').value : (s.color || defaultColors[i % defaultColors.length])
                }))
            };
            
            fetch('/api/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updatedConfig)
            })
            .then(() => {
                config = updatedConfig;
                closeSensorModal();
                updateData();
            })
            .catch(e => alert('–ü–æ–º–∏–ª–∫–∞: ' + e));
        }

        // NTP –º–æ–¥–∞–ª
        function openNTPModal() {
            document.getElementById('ntpServer').value = config.ntpServer || 'pool.ntp.org';
            document.getElementById('ntpModal').classList.add('active');
        }

        function closeNTPModal() {
            document.getElementById('ntpModal').classList.remove('active');
        }

        function saveNTPConfig() {
            const updatedConfig = {
                title: config.title,
                ntpServer: document.getElementById('ntpServer').value,
                updateInterval: config.updateInterval,
                sensors: config.sensors
            };
            
            fetch('/api/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updatedConfig)
            })
            .then(() => {
                config = updatedConfig;
                closeNTPModal();
                document.getElementById('serverName').textContent = config.ntpServer;
                alert('NTP –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –æ–Ω–æ–≤–ª–µ–Ω–æ');
            })
            .catch(e => alert('–ü–æ–º–∏–ª–∫–∞: ' + e));
        }

        initCharts();
        updateData();
        updateTime();
        setInterval(updateData, 10000);
        setInterval(updateTime, 1000);
    </script>
</body>
</html>