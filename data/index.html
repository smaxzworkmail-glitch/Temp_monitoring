<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">–ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { font-family: -apple-system, sans-serif; background: #121212; color: #eee; margin: 0; padding: 15px; padding-bottom: 80px; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        h1 { font-size: 1.2rem; color: #00adb5; margin: 0; flex: 1; cursor: pointer; }
        h1:active { opacity: 0.7; }
        
        .card { background: #1e1e1e; border-radius: 12px; padding: 15px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .temp-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .temp-item { background: #252525; padding: 10px; border-radius: 8px; text-align: center; cursor: pointer; transition: transform 0.1s; }
        .temp-item:active { transform: scale(0.95); }
        .temp-item .color-box { display: inline-block; width: 24px; height: 24px; border-radius: 6px; margin-bottom: 8px; border: 2px solid #333; }
        .temp-name { display: block; font-size: 0.9rem; color: #00adb5; font-weight: bold; cursor: pointer; margin-bottom: 5px; }
        .temp-val { font-size: 1.5rem; font-weight: bold; display: block; }
        .label { font-size: 0.8rem; color: #888; }
        canvas { max-width: 100%; }
        
        /* Footer */
        .footer { position: fixed; bottom: 0; left: 0; right: 0; background: #1e1e1e; border-top: 1px solid #333; padding: 15px; text-align: center; }
        .time-display { font-size: 1.5rem; color: #00adb5; cursor: pointer; font-weight: bold; }
        .time-display:active { opacity: 0.7; }
        .server-name { font-size: 0.75rem; color: #666; margin-top: 5px; }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background: #1e1e1e; border-radius: 12px; padding: 20px; max-width: 90%; width: 400px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { margin: 0; }
        .modal-close { background: none; border: none; color: #00adb5; font-size: 24px; cursor: pointer; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 0.9rem; }
        .form-group input { width: 100%; padding: 8px; background: #252525; border: 1px solid #333; border-radius: 6px; color: #eee; font-family: inherit; }
        .form-group input:focus { outline: none; border-color: #00adb5; }
        .btn { background: #00adb5; color: #000; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn:active { transform: scale(0.95); }
        .btn-cancel { background: #555; color: #eee; margin-left: 10px; }
        .btn-group { display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end; }
    </style>
</head>
<body>
    <div class="header">
        <h1 id="app-title">üå°Ô∏è –°–∏—Å—Ç–µ–º–∞ –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É</h1>
    </div>
    
    <div id="live-temps" class="temp-grid"></div>

    <div class="card">
        <div class="label">–ì–æ–¥–∏–Ω–∞</div>
        <canvas id="hourChart"></canvas>
    </div>

    <div class="card">
        <div class="label">–î–æ–±–∞</div>
        <canvas id="dayChart"></canvas>
    </div>

    <!-- Footer –∑ —á–∞—Å–æ–º -->
    <div class="footer">
        <div class="time-display" id="timeDisplay" onclick="openNTPModal()">--:-- --</div>
        <div class="server-name" id="serverName">system</div>
    </div>

    <!-- Modal –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –¥–∞—Ç—á–∏–∫–∞ -->
    <div id="sensorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –¥–∞—Ç—á–∏–∫–∞</h2>
                <button class="modal-close" onclick="closeSensorModal()">‚úï</button>
            </div>
            <div class="form-group">
                <label>–ù–∞–∑–≤–∞ –¥–∞—Ç—á–∏–∫–∞</label>
                <input type="text" id="sensorName" placeholder="–ù–∞–∑–≤–∞">
            </div>
            <div class="form-group">
                <label>–ö–æ–ª—ñ—Ä</label>
                <input type="color" id="sensorColor">
            </div>
            <div class="btn-group">
                <button class="btn" onclick="saveSensorConfig()">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                <button class="btn btn-cancel" onclick="closeSensorModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            </div>
        </div>
    </div>

    <!-- Modal –¥–ª—è NTP -->
    <div id="ntpModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —á–∞—Å—É</h2>
                <button class="modal-close" onclick="closeNTPModal()">‚úï</button>
            </div>
            <div class="form-group">
                <label>NTP —Å–µ—Ä–≤–µ—Ä</label>
                <input type="text" id="ntpServer" placeholder="pool.ntp.org">
            </div>
            <div class="btn-group">
                <button class="btn" onclick="saveNTPConfig()">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                <button class="btn btn-cancel" onclick="closeNTPModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            </div>
        </div>
    </div>

    <script>
        let hourChart, dayChart;
        let config = {};
        let editingSensorId = null;

        function initCharts() {
            const commonOptions = {
                responsive: true,
                scales: { x: { display: false }, y: { grid: { color: '#333' } } },
                plugins: { legend: { position: 'bottom', labels: { color: '#ccc' } } },
                animation: false
            };

            hourChart = new Chart(document.getElementById('hourChart'), { type: 'line', data: { labels: [], datasets: [] }, options: commonOptions });
            dayChart = new Chart(document.getElementById('dayChart'), { type: 'line', data: { labels: [], datasets: [] }, options: commonOptions });
        }

        function updateTime() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const mins = String(now.getMinutes()).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();
            
            document.getElementById('timeDisplay').textContent = `${hours}:${mins} ${day}.${month}.${year}`;
        }

        async function updateData() {
            try {
                const res = await fetch('/api/data');
                const data = await res.json();
                
                const liveDiv = document.getElementById('live-temps');
                liveDiv.innerHTML = '';
                
                // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∫–æ–Ω—Ñ—ñ“ë—É—Ä–∞—Ü—ñ—é –¥–ª—è –Ω–∞–∑–≤–∏ —Ç–∞ —Å–µ—Ä–≤–µ—Ä—É
                if (!config.title) {
                    const cfgRes = await fetch('/api/config');
                    config = await cfgRes.json();
                    document.getElementById('app-title').textContent = 'üå°Ô∏è ' + config.title;
                    document.getElementById('serverName').textContent = config.ntpServer;
                    document.title = config.title;
                }
                
                data.forEach((sensor, i) => {
                    const color = sensor.color || '#00adb5';
                    const tempHtml = `
                        <div class="temp-item" onclick="openSensorModal(${i})">
                            <div class="color-box" style="background-color: ${color}; margin-left: -4px; margin-right: -4px;"></div>
                            <span class="temp-name" onclick="event.stopPropagation(); editSensorName(${i})">${sensor.name}</span>
                            <span class="temp-val">${sensor.current > -50 ? sensor.current.toFixed(1) : '--'}¬∞C</span>
                        </div>
                    `;
                    liveDiv.innerHTML += tempHtml;
                    
                    // –î–∞–Ω—ñ –¥–ª—è –≥—Ä–∞—Ñ—ñ–∫—ñ–≤
                    updateDataset(hourChart, i, sensor.name, sensor.hour, color);
                    updateDataset(dayChart, i, sensor.name, sensor.day, color);
                });

                hourChart.update();
                dayChart.update();
            } catch (e) { console.error("Data error", e); }
        }

        function updateDataset(chart, index, name, points, color) {
            if (!chart.data.datasets[index]) {
                chart.data.datasets[index] = { 
                    label: name, 
                    data: [], 
                    borderColor: color, 
                    backgroundColor: color + '20',
                    tension: 0.3, 
                    pointRadius: 0,
                    borderWidth: 2
                };
            } else {
                chart.data.datasets[index].label = name;
                chart.data.datasets[index].borderColor = color;
                chart.data.datasets[index].backgroundColor = color + '20';
            }
            chart.data.datasets[index].data = points;
            if (chart.data.labels.length < points.length) {
                chart.data.labels = Array(points.length).fill('');
            }
        }

        // –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –¥–∞—Ç—á–∏–∫–∞ (–∫–æ–ª—ñ—Å + –Ω–∞–∑–≤–∞)
        function openSensorModal(sensorId) {
            editingSensorId = sensorId;
            const sensor = config.sensors[sensorId];
            document.getElementById('sensorName').value = sensor.name;
            document.getElementById('sensorColor').value = sensor.color || '#ff5722';
            document.getElementById('sensorModal').classList.add('active');
        }

        function closeSensorModal() {
            document.getElementById('sensorModal').classList.remove('active');
            editingSensorId = null;
        }

        function saveSensorConfig() {
            if (editingSensorId === null) return;
            
            const updatedConfig = {
                title: config.title,
                ntpServer: config.ntpServer,
                updateInterval: config.updateInterval,
                sensors: config.sensors.map((s, i) => ({
                    id: i,
                    name: i === editingSensorId ? document.getElementById('sensorName').value : s.name,
                    color: i === editingSensorId ? document.getElementById('sensorColor').value : s.color
                }))
            };
            
            fetch('/api/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updatedConfig)
            })
            .then(() => {
                config = updatedConfig;
                closeSensorModal();
                updateData();
            })
            .catch(e => alert('–ü–æ–º–∏–ª–∫–∞: ' + e));
        }

        // –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —Ç—ñ–ª—å–∫–∏ –Ω–∞–∑–≤–∏ (–∫–ª—ñ–∫ –Ω–∞ —Ç–µ–∫—Å—Ç)
        function editSensorName(sensorId) {
            openSensorModal(sensorId);
        }

        // NTP –º–æ–¥–∞–ª
        function openNTPModal() {
            document.getElementById('ntpServer').value = config.ntpServer || 'pool.ntp.org';
            document.getElementById('ntpModal').classList.add('active');
        }

        function closeNTPModal() {
            document.getElementById('ntpModal').classList.remove('active');
        }

        function saveNTPConfig() {
            const updatedConfig = {
                title: config.title,
                ntpServer: document.getElementById('ntpServer').value,
                updateInterval: config.updateInterval,
                sensors: config.sensors
            };
            
            fetch('/api/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updatedConfig)
            })
            .then(() => {
                config = updatedConfig;
                closeNTPModal();
                document.getElementById('serverName').textContent = config.ntpServer;
                alert('NTP –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –æ–Ω–æ–≤–ª–µ–Ω–æ');
            })
            .catch(e => alert('–ü–æ–º–∏–ª–∫–∞: ' + e));
        }

        initCharts();
        updateData();
        updateTime();
        setInterval(updateData, 10000);
        setInterval(updateTime, 1000); // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —á–∞—Å—É –∫–æ–∂–Ω—É —Å–µ–∫—É–Ω–¥—É
    </script>
</body>
</html>